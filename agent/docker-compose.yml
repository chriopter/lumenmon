version: '3.8'

services:
  agent:
    build: .
    container_name: lumenmon-agent
    hostname: agent-${AGENT_ID:-default}
    volumes:
      - ssh-keys:/shared:ro
    networks:
      - lumenmon
    environment:
      - CONSOLE_HOST=lumenmon-console
      - CONSOLE_PORT=22
      - CONSOLE_USER=collector
      - AGENT_ID=${AGENT_ID:-${HOSTNAME:-agent}}
      # Sampling rates for different collectors
      - CPU_SAMPLE_HZ=10        # 10Hz for CPU
      - MEMORY_SAMPLE_HZ=1      # 1Hz for memory
      - DISK_SAMPLE_HZ=0.1      # Every 10s for disk
      - NETWORK_SAMPLE_HZ=0.5   # Every 2s for network
      - PROCESS_SAMPLE_HZ=0.2   # Every 5s for processes
      - SYSTEM_SAMPLE_HZ=0.017  # Every minute for system info
    command: |
      sh -c "
        echo '[agent] Waiting for SSH keys...'
        while [ ! -f /shared/agent_key ]; do sleep 1; done
        cp /shared/agent_key /home/metrics/.ssh/id_rsa
        chmod 600 /home/metrics/.ssh/id_rsa
        echo '[agent] SSH key installed'
        exec /usr/local/bin/coordinator.sh
      "

networks:
  lumenmon:
    name: lumenmon-net
    external: true

volumes:
  ssh-keys:
    name: lumenmon-ssh-keys
    external: true