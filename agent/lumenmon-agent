#!/bin/bash
# Lumenmon agent CLI - manages the monitoring agent service.
# Commands: status, debug, register, start, stop, restart, logs, uninstall

# Resolve symlinks to get real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
export LUMENMON_HOME="${LUMENMON_HOME:-$SCRIPT_DIR}"
export LUMENMON_DATA="${LUMENMON_DATA:-$LUMENMON_HOME/data}"

# Use sudo if not root
if [ "$(id -u)" -eq 0 ]; then
    SUDO=""
else
    SUDO="sudo"
fi

case "${1:-}" in
    register|r)
        shift
        "$LUMENMON_HOME/core/setup/register.sh" "$@"
        ;;
    status|s|"")
        "$LUMENMON_HOME/core/status.sh"
        ;;
    debug|dbg)
        "$LUMENMON_HOME/core/debug.sh"
        ;;
    start)
        $SUDO systemctl start lumenmon-agent
        echo "Agent started"
        ;;
    stop)
        $SUDO systemctl stop lumenmon-agent
        echo "Agent stopped"
        ;;
    restart)
        $SUDO systemctl restart lumenmon-agent
        echo "Agent restarted"
        ;;
    logs|l)
        journalctl -u lumenmon-agent -f
        ;;
    update|u)
        echo "Updating agent..."

        # Find git root (parent of agent dir)
        GIT_ROOT="$(cd "$LUMENMON_HOME/.." && pwd)"

        # Stop service
        $SUDO systemctl stop lumenmon-agent 2>/dev/null || true

        # Fetch branch tip first (this is enough to run updated scripts).
        if ! $SUDO git -C "$GIT_ROOT" fetch origin main; then
            $SUDO systemctl start lumenmon-agent
            echo "Fetch failed, service restarted"
            exit 1
        fi

        # Determine latest remote tag without requiring a full local tag fetch.
        LATEST_TAG=$($SUDO git -C "$GIT_ROOT" ls-remote --tags --refs origin 'v*' | sed 's#.*refs/tags/##' | sort -V | tail -n1)

        # Fetch only the selected tag, force-updating local tag if needed.
        if [ -n "$LATEST_TAG" ]; then
            if ! $SUDO git -C "$GIT_ROOT" fetch origin "+refs/tags/$LATEST_TAG:refs/tags/$LATEST_TAG"; then
                echo "Warning: could not fetch tag $LATEST_TAG, falling back to origin/main"
                LATEST_TAG=""
            fi
        fi

        # Get latest tag and checkout
        if [ -n "$LATEST_TAG" ]; then
            CURRENT=$($SUDO git -C "$GIT_ROOT" describe --tags --always 2>/dev/null || echo "unknown")
            if $SUDO git -C "$GIT_ROOT" checkout "$LATEST_TAG" 2>/dev/null; then
                $SUDO systemctl start lumenmon-agent
                echo "Updated: $CURRENT â†’ $LATEST_TAG"
            else
                $SUDO systemctl start lumenmon-agent
                echo "Local repository state:"
                $SUDO git -C "$GIT_ROOT" status --short --branch || true
                echo "Checkout failed, service restarted"
                exit 1
            fi
        else
            # Fallback to main if no tag exists or tag fetch failed
            $SUDO git -C "$GIT_ROOT" checkout -B main origin/main
            $SUDO systemctl start lumenmon-agent
            echo "Updated to main"
        fi
        ;;
    optional|o)
        CONFIG="$LUMENMON_DATA/config"

        # Load current config
        declare -A CURRENT
        if [[ -f "$CONFIG" ]]; then
            while IFS='=' read -r key value; do
                [[ -z "$key" || "$key" == \#* ]] && continue
                CURRENT["$key"]="$value"
            done < "$CONFIG"
        fi

        # Save config helper
        save_config() {
            : > "$CONFIG"
            for key in "${!CURRENT[@]}"; do
                echo "$key=${CURRENT[$key]}" >> "$CONFIG"
            done
        }

        # Get available optional collectors
        COLLECTORS=()
        for f in "$LUMENMON_HOME/collectors/optional"/*.sh; do
            [[ "$(basename "$f")" == "_init.sh" ]] && continue
            [[ -f "$f" ]] && COLLECTORS+=("$(basename "$f" .sh)")
        done

        if [[ ${#COLLECTORS[@]} -eq 0 ]]; then
            echo "No optional collectors available"
            exit 0
        fi

        show_menu() {
            echo ""
            echo "Optional Collectors"
            echo "==================="
            echo ""

            for i in "${!COLLECTORS[@]}"; do
                name="${COLLECTORS[$i]}"
                status="OFF"
                required=""
                [[ "${CURRENT[$name]:-0}" == "1" ]] && status="ON"
                [[ "${CURRENT[${name}_required]:-0}" == "1" ]] && required=" [!alert]"
                printf "  %d) [%s] %s%s\n" $((i+1)) "$status" "$name" "$required"
            done

            echo ""
            echo "Commands: <number> toggle, <number>r toggle alert, q quit"
        }

        show_menu

        while true; do
            read -r choice
            [[ "$choice" == "q" || "$choice" == "" ]] && break

            # Check for 'r' suffix (e.g., "1r" to toggle required)
            if [[ "$choice" =~ ^([0-9]+)r$ ]]; then
                num="${BASH_REMATCH[1]}"
                if (( num >= 1 && num <= ${#COLLECTORS[@]} )); then
                    name="${COLLECTORS[$((num-1))]}"
                    req_key="${name}_required"

                    if [[ "${CURRENT[$req_key]:-0}" == "1" ]]; then
                        CURRENT["$req_key"]="0"
                        echo "Alert disabled: $name"
                    else
                        CURRENT["$req_key"]="1"
                        echo "Alert enabled: $name (will show error if value=0)"
                    fi
                    save_config
                fi
            elif [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#COLLECTORS[@]} )); then
                name="${COLLECTORS[$((choice-1))]}"

                # Toggle
                if [[ "${CURRENT[$name]:-0}" == "1" ]]; then
                    CURRENT["$name"]="0"
                    CURRENT["${name}_required"]="0"
                    echo "Disabled: $name"
                else
                    CURRENT["$name"]="1"
                    echo "Enabled: $name"
                fi

                save_config
            else
                echo "Invalid choice"
            fi
        done

        echo ""
        echo "Restart agent to apply: lumenmon-agent restart"
        ;;
    uninstall)
        echo "Stopping agent..."
        $SUDO systemctl stop lumenmon-agent 2>/dev/null || true
        $SUDO systemctl disable lumenmon-agent 2>/dev/null || true
        $SUDO rm -f /etc/systemd/system/lumenmon-agent.service
        $SUDO systemctl daemon-reload
        echo "Removing files..."
        GIT_ROOT="$(cd "$LUMENMON_HOME/.." && pwd)"
        $SUDO rm -rf "$GIT_ROOT"
        $SUDO rm -f /usr/local/bin/lumenmon-agent
        echo "Uninstalled"
        ;;
    help|h|--help|-h)
        echo "Usage: lumenmon-agent <command>"
        echo ""
        echo "Commands:"
        echo "  status          Show agent status (default)"
        echo "  debug           Run all collectors once and print outputs"
        echo "  register <url>  Register with invite URL"
        echo "  start           Start agent service"
        echo "  stop            Stop agent service"
        echo "  restart         Restart agent service"
        echo "  logs            View agent logs"
        echo "  update          Update agent from GitHub"
        echo "  optional        Configure optional collectors"
        echo "  uninstall       Remove agent"
        ;;
    *)
        echo "Unknown: $1 (try 'lumenmon-agent help')"
        ;;
esac
