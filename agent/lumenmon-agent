#!/bin/bash
# Lumenmon agent CLI - manages the monitoring agent service.
# Commands: status, register, start, stop, restart, logs, uninstall

# Resolve symlinks to get real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
export LUMENMON_HOME="${LUMENMON_HOME:-$SCRIPT_DIR}"
export LUMENMON_DATA="${LUMENMON_DATA:-$LUMENMON_HOME/data}"

# Use sudo if not root
if [ "$(id -u)" -eq 0 ]; then
    SUDO=""
else
    SUDO="sudo"
fi

case "${1:-}" in
    register|r)
        shift
        "$LUMENMON_HOME/core/setup/register.sh" "$@"
        ;;
    status|s|"")
        "$LUMENMON_HOME/core/status.sh"
        ;;
    start)
        $SUDO systemctl start lumenmon-agent
        echo "Agent started"
        ;;
    stop)
        $SUDO systemctl stop lumenmon-agent
        echo "Agent stopped"
        ;;
    restart)
        $SUDO systemctl restart lumenmon-agent
        echo "Agent restarted"
        ;;
    logs|l)
        journalctl -u lumenmon-agent -f
        ;;
    update|u)
        echo "Updating agent..."

        # Find git root (parent of agent dir)
        GIT_ROOT="$(cd "$LUMENMON_HOME/.." && pwd)"

        # Stop service
        $SUDO systemctl stop lumenmon-agent 2>/dev/null || true

        # Fetch with tags
        if ! $SUDO git -C "$GIT_ROOT" fetch origin --tags; then
            $SUDO systemctl start lumenmon-agent
            echo "Fetch failed, service restarted"
            exit 1
        fi

        # Get latest tag and checkout
        LATEST_TAG=$($SUDO git -C "$GIT_ROOT" tag --sort=-v:refname | head -n1)
        if [ -n "$LATEST_TAG" ]; then
            CURRENT=$($SUDO git -C "$GIT_ROOT" describe --tags --always 2>/dev/null || echo "unknown")
            if $SUDO git -C "$GIT_ROOT" checkout "$LATEST_TAG" 2>/dev/null; then
                $SUDO systemctl start lumenmon-agent
                echo "Updated: $CURRENT â†’ $LATEST_TAG"
            else
                $SUDO systemctl start lumenmon-agent
                echo "Checkout failed, service restarted"
                exit 1
            fi
        else
            # Fallback to main if no tags exist
            $SUDO git -C "$GIT_ROOT" reset --hard origin/main
            $SUDO systemctl start lumenmon-agent
            echo "Updated to main (no release tags found)"
        fi
        ;;
    uninstall)
        echo "Stopping agent..."
        $SUDO systemctl stop lumenmon-agent 2>/dev/null || true
        $SUDO systemctl disable lumenmon-agent 2>/dev/null || true
        $SUDO rm -f /etc/systemd/system/lumenmon-agent.service
        $SUDO systemctl daemon-reload
        echo "Removing files..."
        GIT_ROOT="$(cd "$LUMENMON_HOME/.." && pwd)"
        $SUDO rm -rf "$GIT_ROOT"
        $SUDO rm -f /usr/local/bin/lumenmon-agent
        echo "Uninstalled"
        ;;
    help|h|--help|-h)
        echo "Usage: lumenmon-agent <command>"
        echo ""
        echo "Commands:"
        echo "  status          Show agent status (default)"
        echo "  register <url>  Register with invite URL"
        echo "  start           Start agent service"
        echo "  stop            Stop agent service"
        echo "  restart         Restart agent service"
        echo "  logs            View agent logs"
        echo "  update          Update agent from GitHub"
        echo "  uninstall       Remove agent"
        ;;
    *)
        echo "Unknown: $1 (try 'lumenmon-agent help')"
        ;;
esac
