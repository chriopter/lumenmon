#!/bin/bash
# Directly deploy local changes to remote test server via rsync+SSH.
# Supports fast loops for agent, web, console, all, and status checks.

set -euo pipefail
cd "$(dirname "$0")/.."

if [ -f .env ]; then
    set -a
    source .env
    set +a
fi

TARGET="${1:-}"
if [ -z "$TARGET" ]; then
    echo "Usage: $0 [agent|web|console|all|status|check]"
    echo ""
    echo "  agent   - Deploy agent scripts, restart service"
    echo "  web     - Build CSS + hot-reload web public files"
    echo "  console - Deploy full console app files + restart container"
    echo "  all     - Deploy agent, then console"
    echo "  status  - Check console/agent status on remote host"
    echo "  check   - Run quick remote API/runtime health checks"
    exit 1
fi

if [ -z "${LUMENMON_TEST_HOST:-}" ]; then
    echo "Error: LUMENMON_TEST_HOST not set"
    echo "Set it in shell or repo .env, e.g.:"
    echo "  LUMENMON_TEST_HOST=root@test-server.local"
    exit 1
fi

require_cmd() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "Error: required command not found: $1" >&2
        exit 1
    fi
}

remote() {
    ssh "$LUMENMON_TEST_HOST" "$@"
}

preflight() {
    require_cmd ssh
    require_cmd rsync
    remote "command -v docker >/dev/null && command -v systemctl >/dev/null"
}

deploy_agent() {
    echo "==> Deploying agent to $LUMENMON_TEST_HOST..."
    rsync -avz --delete \
        --exclude='data/' \
        agent/ \
        "$LUMENMON_TEST_HOST:/opt/lumenmon/agent/"

    remote "systemctl restart lumenmon-agent"
    echo "==> Agent status:"
    remote "lumenmon-agent"
}

deploy_web() {
    echo "==> Building CSS with Tailwind..."
    (cd console && npm run build)

    echo "==> Deploying web frontend to $LUMENMON_TEST_HOST..."
    remote "mkdir -p /tmp/lumenmon-dev/public"
    rsync -avz --delete \
        console/web/public/ \
        "$LUMENMON_TEST_HOST:/tmp/lumenmon-dev/public/"

    remote "docker cp /tmp/lumenmon-dev/public/. lumenmon-console:/app/web/public/"
    echo "==> Web files deployed (no restart needed)"
}

deploy_console() {
    echo "==> Deploying full console to $LUMENMON_TEST_HOST..."
    remote "mkdir -p /tmp/lumenmon-dev"

    rsync -avz --delete --exclude='__pycache__/' --exclude='*.pyc' console/web/ "$LUMENMON_TEST_HOST:/tmp/lumenmon-dev/web/"
    rsync -avz --delete --exclude='__pycache__/' --exclude='*.pyc' console/core/ "$LUMENMON_TEST_HOST:/tmp/lumenmon-dev/core/"
    rsync -avz --delete console/config/ "$LUMENMON_TEST_HOST:/tmp/lumenmon-dev/config/"
    scp console/console.sh "$LUMENMON_TEST_HOST:/tmp/lumenmon-dev/console.sh"

    remote "find /tmp/lumenmon-dev -name '*.sh' -exec chmod +x {} \; && chmod +x /tmp/lumenmon-dev/console.sh"

    remote "docker cp /tmp/lumenmon-dev/web/. lumenmon-console:/app/web/"
    remote "docker cp /tmp/lumenmon-dev/core/. lumenmon-console:/app/core/"
    remote "docker cp /tmp/lumenmon-dev/console.sh lumenmon-console:/app/console.sh"
    remote "docker cp /tmp/lumenmon-dev/config/. lumenmon-console:/app/config/"
    remote "docker cp /tmp/lumenmon-dev/web/config/Caddyfile lumenmon-console:/etc/caddy/Caddyfile"
    remote "docker restart lumenmon-console"

    sleep 3
    echo "==> Console status:"
    remote "lumenmon"
}

show_status() {
    echo "==> Console status on $LUMENMON_TEST_HOST:"
    remote "lumenmon"
    echo ""
    echo "==> Agent status on $LUMENMON_TEST_HOST:"
    remote "lumenmon-agent"
}

run_checks() {
    echo "==> Running remote runtime checks on $LUMENMON_TEST_HOST..."
    remote "lumenmon"
    echo ""
    remote "lumenmon-agent"
    echo ""
    remote "curl -fsS http://localhost:8080/api/entities >/dev/null && echo 'Entities API: OK'"
    remote "curl -fsS http://localhost:8080/api/messages/unread-counts >/dev/null && echo 'Messages API: OK'"
    remote "curl -fsS http://localhost:8080/api/messages/staleness >/dev/null && echo 'Mail staleness API: OK'"
    remote "curl -fsS http://localhost:8080/api/alerts/status >/dev/null && echo 'Alerts status API: OK'"
    remote "docker ps --format 'table {{.Names}}\\t{{.Status}}' | grep lumenmon-console"
}

preflight

case "$TARGET" in
    agent)
        deploy_agent
        ;;
    web)
        deploy_web
        ;;
    console)
        deploy_console
        ;;
    all)
        deploy_agent
        echo ""
        deploy_console
        ;;
    status)
        show_status
        ;;
    check)
        run_checks
        ;;
    *)
        echo "Unknown target: $TARGET"
        echo "Use: agent, web, console, all, status, or check"
        exit 1
        ;;
esac

echo ""
echo "Done!"
