#!/bin/bash
# Development auto-setup: resets console, starts dev agent + virtual agent, watches for .reset file.
# For development only.

set -e
cd "$(dirname "$0")/.."

# Clean up .reset file if it exists
rm -f .reset

echo "Stopping containers..."
docker stop lumenmon-console lumenmon-dev-agent lumenmon-virtual-test 2>/dev/null || true
docker rm lumenmon-console lumenmon-dev-agent lumenmon-virtual-test 2>/dev/null || true

echo "Cleaning data..."
rm -rf dev/data 2>/dev/null || true
rm -rf console/data/mqtt/passwd console/data/*.log 2>/dev/null || true
mkdir -p dev/data/mqtt console/data/mqtt

echo "Starting console..."
echo "CONSOLE_HOST=localhost" > console/.env
docker compose -f console/docker-compose.yml up -d --build

echo "Waiting for console..."
sleep 3

echo "Creating invite..."
INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>&1 | grep "^lumenmon://" | head -1)
if [ -z "$INVITE" ]; then
    echo "Failed to create invite"
    exit 1
fi
echo "Invite: $INVITE"

echo "Building dev agent..."
docker build -t lumenmon-dev-agent -f dev/Dockerfile.agent .

echo "Registering agent..."
docker run --rm \
    --network host \
    -e LUMENMON_AUTO_ACCEPT=1 \
    -v "$PWD/dev/data:/opt/lumenmon/data" \
    lumenmon-dev-agent \
    /opt/lumenmon/core/setup/register.sh "$INVITE"

echo "Starting dev agent..."
docker run -d \
    --name lumenmon-dev-agent \
    --network host \
    -v "$PWD/dev/data:/opt/lumenmon/data" \
    --restart unless-stopped \
    lumenmon-dev-agent

echo ""
echo "Starting virtual test agent..."
./dev/add-virtual &
VIRTUAL_PID=$!

echo ""
echo "Done! Dashboard: http://localhost:8080"
echo ""
echo "Logs:  docker logs -f lumenmon-dev-agent"
echo "Stop:  docker stop lumenmon-dev-agent lumenmon-console"
echo ""
echo "Watching for .reset file (touch .reset to restart)..."

# Watch for .reset file to trigger restart
while true; do
    if [ -f .reset ]; then
        echo ""
        echo "[reset] .reset file detected, restarting..."
        rm -f .reset
        kill $VIRTUAL_PID 2>/dev/null || true
        exec "$0"
    fi
    sleep 1
done
