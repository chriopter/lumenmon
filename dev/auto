#!/bin/bash
# Development auto-setup: resets console, starts one dev agent in Docker.
# For development only.

set -e
cd "$(dirname "$0")/.."

echo "Stopping containers..."
docker stop lumenmon-console lumenmon-dev-agent 2>/dev/null || true
docker rm lumenmon-console lumenmon-dev-agent 2>/dev/null || true

echo "Cleaning data..."
rm -rf dev/data 2>/dev/null || true
rm -rf console/data/mqtt/passwd console/data/*.log 2>/dev/null || true
mkdir -p dev/data/mqtt console/data/mqtt

echo "Starting console..."
echo "CONSOLE_HOST=localhost" > console/.env
docker compose -f console/docker-compose.yml up -d --build

echo "Waiting for console..."
sleep 3

echo "Creating invite..."
INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>&1 | grep "^lumenmon://" | head -1)
if [ -z "$INVITE" ]; then
    echo "Failed to create invite"
    exit 1
fi
echo "Invite: $INVITE"

echo "Building dev agent..."
docker build -t lumenmon-dev-agent -f dev/Dockerfile.agent .

echo "Registering agent..."
docker run --rm \
    --network host \
    -v "$PWD/dev/data:/opt/lumenmon/data" \
    lumenmon-dev-agent \
    sh -c "echo yes | /opt/lumenmon/core/setup/register.sh '$INVITE'"

echo "Starting dev agent..."
docker run -d \
    --name lumenmon-dev-agent \
    --network host \
    -v "$PWD/dev/data:/opt/lumenmon/data" \
    --restart unless-stopped \
    lumenmon-dev-agent

echo ""
echo "Done! Dashboard: http://localhost:8080"
echo ""
echo "Logs:  docker logs -f lumenmon-dev-agent"
echo "Stop:  docker stop lumenmon-dev-agent lumenmon-console"
