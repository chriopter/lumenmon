#!/bin/bash
# Development auto-setup that resets containers, registers agent, and launches TUI dashboard.
# Performs full reset, creates invite, registers agent with console, and opens interactive TUI.

# Step 1: Reset everything (same as dev/reset)
echo "ğŸ”„ Stopping containers..."
docker stop lumenmon-console lumenmon-agent 2>/dev/null || true
docker rm lumenmon-console lumenmon-agent 2>/dev/null || true

echo "ğŸ§¹ Cleaning data..."
rm -rf agent/data/debug/* agent/data/ssh/* 2>/dev/null || true
rm -rf console/data/agents/id_* console/data/ssh/ssh_host* console/data/*.log 2>/dev/null || true
mkdir -p agent/data/{debug,ssh} console/data/{agents,ssh}

# Step 2: Start containers
echo "ğŸš€ Starting fresh..."
echo "CONSOLE_HOST=localhost" > console/.env
docker compose -f console/docker-compose.yml up -d --build
CONSOLE_HOST=localhost CONSOLE_PORT=2345 docker compose -f agent/docker-compose.yml up -d --build

# Step 3: Wait for console to be ready
echo "â³ Waiting for console to be ready..."
sleep 3

# Step 4: Create invite and register agent
echo "ğŸ”‘ Creating invite..."
INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>/dev/null | grep "^ssh://")
if [ -z "$INVITE" ]; then
    echo "âŒ Failed to create invite"
    exit 1
fi
echo "   Invite: $INVITE"

echo "ğŸ“ Registering agent..."
docker exec lumenmon-agent /app/core/setup/register.sh "$INVITE"

# Give agent a moment to connect
echo "â³ Waiting for agent to connect..."
sleep 2

# Step 5: Launch TUI
echo "ğŸ“Š Launching TUI..."
docker exec -it lumenmon-console /app/tui.sh