#!/bin/bash
# Development auto-setup: resets console, registers local agent, starts collectors.
# For development only - runs agent directly (not via systemd).

set -e
cd "$(dirname "$0")/.."

echo "Stopping console..."
docker stop lumenmon-console 2>/dev/null || true
docker rm lumenmon-console 2>/dev/null || true

echo "Cleaning data..."
rm -rf agent/data/mqtt/* 2>/dev/null || true
rm -rf console/data/mqtt/passwd console/data/*.log 2>/dev/null || true
mkdir -p agent/data/mqtt console/data/mqtt

echo "Starting console..."
echo "CONSOLE_HOST=localhost" > console/.env
docker compose -f console/docker-compose.yml up -d --build

echo "Waiting for console..."
sleep 3

echo "Creating invite..."
INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>&1 | grep "^lumenmon://" | head -1)
if [ -z "$INVITE" ]; then
    echo "Failed to create invite"
    exit 1
fi
echo "Invite: $INVITE"

echo "Registering agent..."
export LUMENMON_HOME="$PWD/agent"
export LUMENMON_DATA="$LUMENMON_HOME/data"
echo "yes" | "$LUMENMON_HOME/core/setup/register.sh" "$INVITE"

echo "Starting agent (foreground for dev)..."
echo "Press Ctrl+C to stop"
exec "$LUMENMON_HOME/agent.sh"
