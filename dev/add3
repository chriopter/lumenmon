#!/bin/bash
# Spawns 3 agent containers and auto-registers them with the console.
# Useful for testing multi-agent scenarios without overwhelming the system.

set -euo pipefail

echo "ðŸš€ Adding 3 agents to console..."

# Check if console is running
if ! docker ps | grep -q lumenmon-console; then
    echo "âŒ Console not running. Start it first with ./dev/start"
    exit 1
fi

# Clean up any existing test agents
echo "ðŸ§¹ Cleaning up existing test agents..."
docker stop $(docker ps -q --filter name=lumenmon-agent-) 2>/dev/null || true
docker rm $(docker ps -aq --filter name=lumenmon-agent-) 2>/dev/null || true
rm -rf agent/data/agents/agent-* 2>/dev/null || true

# Create temp directory for log files
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Function to create and register a single agent
create_agent() {
    local i=$1
    local AGENT_NAME="agent-$i"
    local LOG_FILE="$TEMP_DIR/agent-$i.log"

    {
        echo ""
        echo "ðŸ“¦ Creating agent $i/3: $AGENT_NAME"

        # Create isolated data directory for this agent
        local AGENT_DATA_DIR="agent/data/agents/$AGENT_NAME"
        mkdir -p "$AGENT_DATA_DIR/mqtt"

        # Create invite
        echo "ðŸ”‘ Creating invite for $AGENT_NAME..."
        local INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>&1 | grep "lumenmon register" | sed 's/.*lumenmon register "\(.*\)"/\1/')
        if [ -z "$INVITE" ]; then
            echo "âŒ Failed to create invite for $AGENT_NAME"
            return 1
        fi

        # Start agent container on lumenmon-net network
        echo "ðŸš€ Starting $AGENT_NAME..."
        docker run -d \
            --name "lumenmon-$AGENT_NAME" \
            --hostname "$AGENT_NAME" \
            --network lumenmon-net \
            -v "$(pwd)/$AGENT_DATA_DIR/mqtt:/data/mqtt" \
            ghcr.io/chriopter/lumenmon-agent:latest \
            > /dev/null

        # Wait for agent container to initialize
        sleep 2

        # Register agent with auto-accept certificate
        echo "ðŸ“ Registering $AGENT_NAME..."
        echo "yes" | docker exec -i "lumenmon-$AGENT_NAME" /app/core/setup/register.sh "$INVITE" 2>&1 | grep -E "\[register\]|ERROR|âœ“" || true

        # Restart agent to start collectors
        docker restart "lumenmon-$AGENT_NAME" > /dev/null
    } > "$LOG_FILE" 2>&1
}

# Create 3 agents sequentially (no need for staggering with just 3)
for i in $(seq 1 3); do
    create_agent $i
done

echo ""
echo "âœ… All 3 agents created and registered!"
echo ""
echo "ðŸ“Š View dashboard:"
echo "   docker exec -it lumenmon-console /app/tui.sh"
echo ""
echo "ðŸ§¹ Cleanup all agents:"
echo "   docker stop \$(docker ps -q --filter name=lumenmon-agent-) && docker rm \$(docker ps -aq --filter name=lumenmon-agent-)"
