#!/bin/bash
# Spawns 3 agent instances as background processes for testing.
# Each agent runs in its own data directory.

set -euo pipefail
cd "$(dirname "$0")/.."

echo "Adding 3 agents..."

# Check if console is running
if ! docker ps | grep -q lumenmon-console; then
    echo "Console not running. Start it first with ./dev/auto"
    exit 1
fi

# Clean up any existing test agents
echo "Cleaning up existing test agents..."
pkill -f "agent/data/agents/agent-" 2>/dev/null || true
rm -rf agent/data/agents 2>/dev/null || true

# Create agents
for i in $(seq 1 3); do
    AGENT_NAME="agent-$i"
    AGENT_DATA="agent/data/agents/$AGENT_NAME"

    echo "Creating $AGENT_NAME..."
    mkdir -p "$AGENT_DATA/mqtt"

    # Get invite
    INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>&1 | grep "^lumenmon://" | head -1)
    if [ -z "$INVITE" ]; then
        echo "Failed to create invite for $AGENT_NAME"
        continue
    fi

    # Register
    export LUMENMON_HOME="$PWD/agent"
    export LUMENMON_DATA="$PWD/$AGENT_DATA"
    echo "yes" | "$LUMENMON_HOME/core/setup/register.sh" "$INVITE" >/dev/null 2>&1

    # Start in background
    "$LUMENMON_HOME/agent.sh" &
    echo "  Started $AGENT_NAME (PID $!)"
done

echo ""
echo "All 3 agents started!"
echo "View: http://localhost:8080/"
echo "Stop: pkill -f 'agent/data/agents/agent-'"
