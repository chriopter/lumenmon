#!/bin/bash
# Spawns 3 dev agent containers for testing.

set -euo pipefail
cd "$(dirname "$0")/.."

echo "Adding 3 dev agents..."

# Check if console is running
if ! docker ps | grep -q lumenmon-console; then
    echo "Console not running. Start it first with ./dev/auto"
    exit 1
fi

# Build agent image if needed
if ! docker images | grep -q lumenmon-dev-agent; then
    echo "Building dev agent image..."
    docker build -t lumenmon-dev-agent -f dev/Dockerfile.agent .
fi

# Clean up existing test agents
echo "Cleaning up existing test agents..."
for i in 1 2 3; do
    docker stop "lumenmon-dev-agent-$i" 2>/dev/null || true
    docker rm "lumenmon-dev-agent-$i" 2>/dev/null || true
done
rm -rf dev/data/agents 2>/dev/null || true

# Create agents
for i in 1 2 3; do
    AGENT_NAME="agent-$i"
    AGENT_DATA="dev/data/agents/$AGENT_NAME"

    echo "Creating $AGENT_NAME..."
    mkdir -p "$AGENT_DATA/mqtt"

    # Get invite
    INVITE=$(docker exec lumenmon-console /app/core/enrollment/invite_create.sh 2>&1 | grep "^lumenmon://" | head -1)
    if [ -z "$INVITE" ]; then
        echo "Failed to create invite for $AGENT_NAME"
        continue
    fi

    # Register
    docker run --rm \
        --network host \
        -e LUMENMON_AUTO_ACCEPT=1 \
        -v "$PWD/$AGENT_DATA:/opt/lumenmon/data" \
        lumenmon-dev-agent \
        /opt/lumenmon/core/setup/register.sh "$INVITE" >/dev/null 2>&1

    # Start
    docker run -d \
        --name "lumenmon-dev-agent-$i" \
        --network host \
        -v "$PWD/$AGENT_DATA:/opt/lumenmon/data" \
        --restart unless-stopped \
        lumenmon-dev-agent

    echo "  Started $AGENT_NAME"
done

echo ""
echo "All 3 agents started!"
echo "View: http://localhost:8080"
echo "Stop: docker stop lumenmon-dev-agent-1 lumenmon-dev-agent-2 lumenmon-dev-agent-3"
