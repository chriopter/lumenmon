<!--
Logger component with ASCII logo and scrolling log entries.
Provides addLog(message, level) function for inline event logging. Max 50 entries, auto-scrolls.
-->
<div class="log-box" id="log-box">
    <div class="logo-ascii">  ██╗     ██╗   ██╗███╗   ███╗███████╗███╗   ██╗███╗   ███╗ ██████╗ ███╗   ██╗
  ██║     ██║   ██║████╗ ████║██╔════╝████╗  ██║████╗ ████║██╔═══██╗████╗  ██║
  ██║     ██║   ██║██╔████╔██║█████╗  ██╔██╗ ██║██╔████╔██║██║   ██║██╔██╗ ██║
  ██║     ██║   ██║██║╚██╔╝██║██╔══╝  ██║╚██╗██║██║╚██╔╝██║██║   ██║██║╚██╗██║
  ███████╗╚██████╔╝██║ ╚═╝ ██║███████╗██║ ╚████║██║ ╚═╝ ██║╚██████╔╝██║ ╚████║
  ╚══════╝ ╚═════╝ ╚═╝     ╚═╝╚══════╝╚═╝  ╚═══╝╚═╝     ╚═╝ ╚═════╝ ╚═╝  ╚═══╝</div>
    <div id="log-entries"></div>
    <div id="collector-coverage" class="log-entry" style="margin-top: 0.5rem; border-top: 1px solid #313244; padding-top: 0.35rem;">
        <span class="log-timestamp">[debug]</span><span class="log-level-info">collectors: loading coverage...</span>
    </div>
</div>

<script>
    function addLog(message, level = 'info') {
        const logEntries = document.getElementById('log-entries');
        const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span class="log-level-${level}">${message}</span>`;
        logEntries.appendChild(entry);

        const logBox = document.getElementById('log-box');
        logBox.scrollTop = logBox.scrollHeight;

        while (logEntries.children.length > 50) {
            logEntries.removeChild(logEntries.firstChild);
        }
    }

    // MQTT message tracking - state managed in window.app (index.html)

    async function checkMqttMessages() {
        try {
            const response = await fetch('/api/mqtt/test');
            const data = await response.json();

            if (data.count > window.app.mqtt.lastMqttCount) {
                // New messages arrived
                const newMessages = data.messages.slice(window.app.mqtt.lastMqttCount);
                newMessages.forEach(msg => {
                    // Parse message format: "[timestamp] topic: payload"
                    const match = msg.match(/\[([^\]]+)\]\s+([^:]+):\s+(.+)/);
                    if (match) {
                        const topic = match[2];
                        const payload = match[3];
                        addLog(`MQTT ${topic}: ${payload}`, 'mqtt');
                    } else {
                        addLog(`MQTT: ${msg}`, 'mqtt');
                    }
                });
                window.app.mqtt.lastMqttCount = data.count;
            }
        } catch (error) {
            // Silently ignore MQTT errors (endpoint might not be available)
        }
    }

    // MQTT polling disabled - endpoint not implemented
    // window.addEventListener('load', () => {
    //     checkMqttMessages();
    //     window.app.mqtt.checkInterval = setInterval(checkMqttMessages, 2000);
    // });

    async function refreshCollectorCoverage() {
        const el = document.getElementById('collector-coverage');
        if (!el) return;

        try {
            const response = await fetch('/api/collectors/coverage');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            const summary = data.summary || {};
            const collectors = data.collectors || [];

            const missing = collectors
                .filter(c => c.status === 'no_data')
                .map(c => c.collector)
                .sort();

            const header = `collectors without data: ${summary.metric_collectors_without_data || 0}/${summary.metric_collectors || 0}`;
            const details = missing.length > 0 ? missing.join(', ') : 'none';

            el.innerHTML = `<span class="log-timestamp">[debug]</span><span class="${missing.length > 0 ? 'log-level-warning' : 'log-level-success'}">${header}</span><div style="margin-top:0.2rem; color:#bac2de; white-space:normal; word-break:break-word;">${details}</div>`;
        } catch (error) {
            el.innerHTML = `<span class="log-timestamp">[debug]</span><span class="log-level-error">collector coverage error: ${error.message}</span>`;
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        refreshCollectorCoverage();
        setInterval(refreshCollectorCoverage, 30000);
    });
</script>
