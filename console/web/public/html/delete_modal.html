<!--
Delete confirmation modal for removing agents completely.
Functions: openDeleteConfirmation(), closeDeleteConfirmation(), confirmDelete(), openResetConfirmation()
-->
<div id="delete-modal" class="delete-modal" style="display: none;">
    <div class="delete-content">
        <div class="delete-header">
            <span>âš  delete agent - <kbd>esc</kbd> to cancel</span>
        </div>
        <div id="delete-body" class="delete-body">
            <p class="delete-question">Delete agent and all data?</p>
            <p class="delete-agent-info" id="delete-agent-info">agent</p>
            <div class="delete-buttons">
                <span class="delete-option" onclick="closeDeleteConfirmation()">[Cancel]</span>
                <span class="delete-option delete-confirm" onclick="confirmDelete()">[Delete]</span>
            </div>
        </div>
    </div>
</div>

<style>
.delete-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-content {
    background: var(--background1);
    border: 1px solid #f38ba8;
    border-radius: 6px;
    width: 90%;
    max-width: 500px;
    padding: 1rem;
    font-family: monospace;
}

.delete-header {
    color: #f38ba8;
    font-size: 0.85rem;
    margin-bottom: 1rem;
}

.delete-body {
    color: var(--foreground1);
    font-size: 0.85rem;
    line-height: 1.6;
}

.delete-question {
    margin-bottom: 0.75rem;
}

.delete-agent-info {
    color: #89b4fa;
    margin-bottom: 1rem;
}

.delete-buttons {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    justify-content: center;
}

.delete-option {
    font-family: monospace;
    font-size: 0.85rem;
    cursor: pointer;
    color: var(--foreground1);
}

.delete-option:hover {
    color: #89b4fa;
}

.delete-confirm {
    color: #f38ba8;
}

.delete-confirm:hover {
    color: #f5c2e7;
}
</style>

<script>
    // UI state managed in window.app (index.html)

    function openDeleteConfirmation() {
        const agent = getSelectedAgent();
        if (!agent) {
            addLog('no agent selected', 'error');
            return;
        }

        window.app.ui.agentToDelete = agent;

        // Update modal content
        const agentInfo = document.getElementById('delete-agent-info');
        const displayName = agent.hostname || agent.id;
        agentInfo.textContent = `${displayName} (${agent.id})`;

        // Show modal
        const modal = document.getElementById('delete-modal');
        modal.style.display = 'flex';

        // Add Enter key listener for this modal
        document.addEventListener('keydown', deleteModalKeyHandler);
    }

    function closeDeleteConfirmation() {
        const modal = document.getElementById('delete-modal');
        modal.style.display = 'none';
        window.app.ui.agentToDelete = null;

        // Remove Enter key listener
        document.removeEventListener('keydown', deleteModalKeyHandler);
    }

    function deleteModalKeyHandler(e) {
        const modal = document.getElementById('delete-modal');
        if (modal.style.display === 'none') return;

        if (e.key === 'Enter') {
            e.preventDefault();
            confirmDelete();
        }
    }

    async function confirmDelete() {
        if (!window.app.ui.agentToDelete) {
            closeDeleteConfirmation();
            return;
        }

        const agentId = window.app.ui.agentToDelete.id;
        const displayName = window.app.ui.agentToDelete.hostname || agentId;

        closeDeleteConfirmation();
        addLog(`deleting agent ${displayName}...`, 'info');

        try {
            const response = await fetch(`/api/agents/${agentId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                addLog(`agent deleted: ${displayName}`, 'success');
                // Refresh agent list after short delay
                setTimeout(() => {
                    fetchAgents();
                }, 1000);
            } else {
                addLog(`deletion failed: ${result.message}`, 'error');
                console.error('Delete error:', result);
            }
        } catch (error) {
            addLog(`deletion error: ${error.message}`, 'error');
            console.error('Delete exception:', error);
        }

        window.app.ui.agentToDelete = null;
    }

    async function openResetConfirmation() {
        const agent = getSelectedAgent();
        if (!agent) {
            addLog('no agent selected', 'error');
            return;
        }

        if (agent.type === 'invite') {
            addLog('cannot reset invite entries', 'error');
            return;
        }

        const displayName = agent.hostname || agent.id;
        const ok = confirm(`Reset metrics for ${displayName} (${agent.id})?\n\nThis removes metric history and current values, keeps mail/messages, and repopulates on next agent cycle.`);
        if (!ok) return;

        addLog(`resetting agent metrics for ${displayName}...`, 'info');
        try {
            const response = await fetch(`/api/agents/${agent.id}/reset`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) {
                addLog(`agent metrics reset: ${displayName}`, 'success');
                setTimeout(() => {
                    fetchAgents();
                    if (window.app.ui.detailViewOpen) {
                        openDetailView();
                    }
                }, 800);
            } else {
                addLog(`reset failed: ${result.message}`, 'error');
            }
        } catch (error) {
            addLog(`reset error: ${error.message}`, 'error');
        }
    }
</script>
