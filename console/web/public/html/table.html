<!--
Agents table component with live HTML fragment updates via /api/agents/table.
Fetches server-rendered rows every 1s. Provides row selection, navigation functions, and getSelectedAgent().
-->
<div class="agents-section">
    <table id="agents-table">
        <thead>
            <tr>
                <td>hostname</td>
                <td>cpu</td>
                <td>mem</td>
                <td>disk</td>
            </tr>
        </thead>
        <tbody id="agents-tbody">
            <tr>
                <td colspan="4" class="no-data">loading...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    let selectedRow = 0;
    let previousAgentCount = 0;
    let isFirstLoad = true;

    async function fetchAgents() {
        try {
            const response = await fetch('/api/agents/table');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const html = await response.text();

            const tbody = document.getElementById('agents-tbody');
            tbody.innerHTML = html;

            attachRowHandlers();

            // Restore highlight after content refresh
            const rows = tbody.querySelectorAll('.agent-row');
            if (rows.length > 0) {
                // Clamp selectedRow to valid range
                if (selectedRow >= rows.length) {
                    selectedRow = rows.length - 1;
                }
                selectRow(selectedRow);
            }

            const currentCount = rows.length;
            if (previousAgentCount !== 0 && currentCount > previousAgentCount) {
                addLog(`agent connected (total: ${currentCount})`, 'success');
            } else if (previousAgentCount !== 0 && currentCount < previousAgentCount) {
                addLog(`agent disconnected (total: ${currentCount})`, 'error');
            }
            previousAgentCount = currentCount;

            // Auto-open detail view on first load if agents exist
            if (isFirstLoad && currentCount > 0) {
                isFirstLoad = false;
                setTimeout(() => {
                    openDetailView();
                }, 100);
            }

            // Refresh detail view after table updates (if open)
            if (typeof refreshDetailView === 'function' && detailViewOpen) {
                refreshDetailView();
            }

        } catch (error) {
            console.error('Error:', error);
            const tbody = document.getElementById('agents-tbody');
            tbody.innerHTML = `<tr><td colspan="4" class="no-data">error: ${error.message}</td></tr>`;
            addLog(`error fetching agents: ${error.message}`, 'error');
        }
    }

    function attachRowHandlers() {
        const rows = document.querySelectorAll('.agent-row');
        rows.forEach(row => {
            row.addEventListener('click', () => {
                const index = parseInt(row.dataset.index);
                selectRow(index);
            });
        });
    }

    function selectRow(index) {
        const rows = document.querySelectorAll('.agent-row');
        if (index < 0 || index >= rows.length) return;

        selectedRow = index;

        rows.forEach((row, i) => {
            if (i === index) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }

    function moveSelection(direction) {
        const rows = document.querySelectorAll('.agent-row');
        if (rows.length === 0) return;

        const newIndex = selectedRow + direction;
        if (newIndex >= 0 && newIndex < rows.length) {
            selectRow(newIndex);
            const row = rows[newIndex];
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Auto-open detail view if not already open, or refresh if open
            if (typeof openDetailView === 'function') {
                openDetailView();
            }
        }
    }

    function getSelectedAgent() {
        const row = document.querySelector(`.agent-row[data-index="${selectedRow}"]`);
        if (!row) {
            console.error('No row found for selected index:', selectedRow);
            return null;
        }

        try {
            return {
                id: row.dataset.agentId,
                hostname: row.dataset.hostname || '',
                status: row.dataset.status,
                age: row.dataset.age,
                cpuHistory: row.dataset.cpuHistory ? JSON.parse(row.dataset.cpuHistory) : [],
                memHistory: row.dataset.memHistory ? JSON.parse(row.dataset.memHistory) : [],
                diskHistory: row.dataset.diskHistory ? JSON.parse(row.dataset.diskHistory) : []
            };
        } catch (error) {
            console.error('Error parsing agent data:', error);
            console.log('Row data:', {
                cpuHistory: row.dataset.cpuHistory,
                memHistory: row.dataset.memHistory,
                diskHistory: row.dataset.diskHistory
            });
            return null;
        }
    }

    // Initialize
    addLog('console started', 'success');
    addLog('loading agents...', 'info');
    fetchAgents();
    window.globalClock.register(fetchAgents);
</script>
