<!--
Agents table component with live HTML fragment updates via /api/agents/table.
Fetches server-rendered rows every 1s. Provides row selection, navigation functions, and getSelectedAgent().
-->
<div class="agents-section">
    <table id="agents-table">
        <thead>
            <tr>
                <td>hostname</td>
                <td>cpu</td>
                <td>mem</td>
                <td>disk</td>
            </tr>
        </thead>
        <tbody id="agents-tbody">
            <tr>
                <td colspan="4" class="no-data">loading...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    // UI state managed in window.app (index.html)

    async function fetchAgents() {
        try {
            const response = await fetch('/api/entities');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            const tbody = document.getElementById('agents-tbody');

            // Render entities
            if (data.entities && data.entities.length > 0) {
                // Sort: valid agents first (alphabetically), then invites/pending
                const sortedEntities = [...data.entities].sort((a, b) => {
                    // Valid agents come before invalid/invites
                    if (a.valid && !b.valid) return -1;
                    if (!a.valid && b.valid) return 1;

                    // Within same validity, sort alphabetically
                    const aName = (a.hostname || a.id).toLowerCase();
                    const bName = (b.hostname || b.id).toLowerCase();
                    return aName.localeCompare(bName);
                });

                let html = '';
                sortedEntities.forEach((entity, index) => {
                    const selected = index === 0 ? 'selected' : '';
                    const validClass = entity.valid ? '' : 'entity-invalid';

                    if (entity.type === 'invite') {
                        // Render invite row
                        const statusDot = entity.valid ? 'online' : 'offline';
                        html += `<tr class="agent-row entity-invite ${selected} ${validClass}" data-index="${index}" data-entity-id="${entity.id}" data-entity-type="invite" data-valid="${entity.valid}">`;
                        html += `<td><span class="status-dot ${statusDot}" title="${entity.valid ? 'active invite' : 'invalid'}"></span>${entity.id} â—·</td>`;
                        html += `<td colspan="3"></td>`;
                        html += `</tr>`;
                    } else {
                        // Render agent row
                        const statusDot = entity.status || 'offline';
                        const hostname = entity.hostname || entity.id;
                        const cpu = entity.cpu || 0;
                        const memory = entity.memory || 0;
                        const disk = entity.disk || 0;
                        const cpuSparkline = entity.cpuSparkline || '';
                        const memSparkline = entity.memSparkline || '';
                        const cpuHistory = JSON.stringify(entity.cpuHistory || []);
                        const memHistory = JSON.stringify(entity.memHistory || []);
                        const diskHistory = JSON.stringify(entity.diskHistory || []);
                        const pendingInvite = entity.pending_invite ? JSON.stringify(entity.pending_invite) : '';

                        html += `<tr class="agent-row ${selected} ${validClass}" data-index="${index}" data-entity-id="${entity.id}" data-entity-type="agent" data-hostname="${hostname}" data-status="${statusDot}" data-valid="${entity.valid}" data-age="${entity.age || 0}" data-uptime="${entity.uptime || ''}" data-heartbeat="${entity.heartbeat || 0}" data-cpu-history='${cpuHistory}' data-mem-history='${memHistory}' data-disk-history='${diskHistory}' data-pending-invite='${pendingInvite}'>`;
                        const pendingSymbol = entity.valid ? '' : ' (pending)';
                        html += `<td title="ID: ${entity.id}"><span class="status-dot ${statusDot}" title="${statusDot}"></span>${hostname}${pendingSymbol}</td>`;
                        html += `<td>${cpu.toFixed(1)}%<span class="sparkline">${cpuSparkline}</span></td>`;
                        html += `<td>${memory.toFixed(1)}%<span class="sparkline">${memSparkline}</span></td>`;
                        html += `<td>${disk.toFixed(1)}%</td>`;
                        html += `</tr>`;
                    }
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="no-data">no agents connected</td></tr>`;
            }

            attachRowHandlers();

            // Restore highlight after content refresh
            const rows = tbody.querySelectorAll('.agent-row');
            if (rows.length > 0) {
                // Clamp selectedRow to valid range
                if (window.app.ui.selectedRow >= rows.length) {
                    window.app.ui.selectedRow = rows.length - 1;
                }
                selectRow(window.app.ui.selectedRow);
            }

            const currentCount = rows.length;
            if (window.app.data.previousAgentCount !== 0 && currentCount > window.app.data.previousAgentCount) {
                addLog(`entity added (total: ${currentCount})`, 'success');
            } else if (window.app.data.previousAgentCount !== 0 && currentCount < window.app.data.previousAgentCount) {
                addLog(`entity removed (total: ${currentCount})`, 'error');
            }
            window.app.data.previousAgentCount = currentCount;

            // Auto-open detail view on first load if entities exist
            if (window.app.data.isFirstLoad && currentCount > 0) {
                window.app.data.isFirstLoad = false;
                setTimeout(() => {
                    openDetailView();
                }, 100);
            }

            // Refresh detail view after table updates (if open)
            if (typeof refreshDetailView === 'function' && window.app.ui.detailViewOpen) {
                refreshDetailView();
            }

        } catch (error) {
            console.error('Error:', error);
            const tbody = document.getElementById('agents-tbody');
            tbody.innerHTML = `<tr><td colspan="4" class="no-data">error: ${error.message}</td></tr>`;
            addLog(`error fetching entities: ${error.message}`, 'error');
        }
    }

    function attachRowHandlers() {
        const rows = document.querySelectorAll('.agent-row');
        rows.forEach(row => {
            row.addEventListener('click', () => {
                const index = parseInt(row.dataset.index);
                selectRow(index);

                // If it's an invite, copy URL on click
                if (row.dataset.entityType === 'invite') {
                    copyInviteUrl(row.dataset.entityId);
                } else {
                    // For agents, open detail view
                    openDetailView();
                }
            });
        });
    }

    function selectRow(index) {
        const rows = document.querySelectorAll('.agent-row');
        if (index < 0 || index >= rows.length) return;

        window.app.ui.selectedRow = index;

        rows.forEach((row, i) => {
            if (i === index) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }

    function moveSelection(direction) {
        const rows = document.querySelectorAll('.agent-row');
        if (rows.length === 0) return;

        const newIndex = window.app.ui.selectedRow + direction;
        if (newIndex >= 0 && newIndex < rows.length) {
            selectRow(newIndex);
            const row = rows[newIndex];
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Auto-open detail view if not already open, or refresh if open
            if (typeof openDetailView === 'function') {
                openDetailView();
            }
        }
    }

    function getSelectedAgent() {
        const row = document.querySelector(`.agent-row[data-index="${window.app.ui.selectedRow}"]`);
        if (!row) {
            console.error('No row found for selected index:', window.app.ui.selectedRow);
            return null;
        }

        try {
            const data = {
                id: row.dataset.entityId || row.dataset.agentId,
                type: row.dataset.entityType || 'agent',
                valid: row.dataset.valid === 'true',
                hostname: row.dataset.hostname || '',
                status: row.dataset.status,
                age: row.dataset.age,
                uptime: row.dataset.uptime || '',
                heartbeat: parseInt(row.dataset.heartbeat) || 0,
                cpuHistory: row.dataset.cpuHistory ? JSON.parse(row.dataset.cpuHistory) : [],
                memHistory: row.dataset.memHistory ? JSON.parse(row.dataset.memHistory) : [],
                diskHistory: row.dataset.diskHistory ? JSON.parse(row.dataset.diskHistory) : []
            };

            // Add pending invite if exists
            if (row.dataset.pendingInvite) {
                data.pending_invite = JSON.parse(row.dataset.pendingInvite);
            }

            return data;
        } catch (error) {
            console.error('Error parsing entity data:', error);
            return null;
        }
    }

    async function copyInviteUrl(inviteId) {
        try {
            const response = await fetch(`/api/invites/${inviteId}/url`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            if (data.success) {
                // Use shared utility to copy
                const copied = await copyText(data.install_command, 'invite command copied to clipboard');
                if (!copied) {
                    // Fallback: show in log if clipboard fails
                    addLog(`invite: ${data.install_command}`, 'info');
                }
            } else {
                addLog(`copy failed: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            addLog(`error copying invite: ${error.message}`, 'error');
        }
    }

    // Initialize
    addLog('console started', 'success');
    addLog('loading agents...', 'info');
    fetchAgents();
    window.globalClock.register(fetchAgents);
</script>
