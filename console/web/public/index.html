<!DOCTYPE html>
<html lang="en" data-webtui-theme="catppuccin-mocha">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumenmon Console</title>
    <link rel="stylesheet" href="/css/webtui.css">
    <link rel="stylesheet" href="/css/catppuccin.css">
    <style>
        body {
            margin: 1rem;
            max-width: 1400px;
        }

        .log-box {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--foreground2);
            background: var(--background1);
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .logo-ascii {
            color: var(--accent1);
            font-size: 8px;
            line-height: 1.1;
            margin-bottom: 0.5rem;
            white-space: pre;
        }

        .log-entry {
            margin: 0.25rem 0;
            color: var(--foreground1);
        }

        .log-timestamp {
            color: var(--foreground2);
            margin-right: 0.5rem;
        }

        .log-level-info {
            color: var(--accent2);
        }

        .log-level-success {
            color: var(--accent3);
        }

        .log-level-error {
            color: var(--accent4);
        }

        .shortcuts {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid var(--foreground2);
            font-size: 0.85rem;
        }

        section {
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1rem;
            margin: 0 0 0.5rem 0;
            padding: 0.5rem;
            background: var(--background2);
            border: 1px solid var(--foreground2);
        }

        .section-content {
            padding: 1rem;
            border: 1px solid var(--foreground2);
            border-top: none;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .status-item {
            padding: 0.5rem;
            border: 1px solid var(--foreground2);
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--foreground2);
        }

        .status-value {
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .invite-box {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--foreground2);
        }

        .invite-url {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: var(--background1);
            border: 1px solid var(--foreground2);
            word-break: break-all;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .invite-url:hover {
            background: var(--background2);
        }

        .message {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--foreground2);
            border: 1px dashed var(--foreground2);
        }

        .metric-bar {
            display: inline-block;
            margin-left: 0.5rem;
        }

        footer {
            margin-top: 2rem;
            padding: 1rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--foreground2);
            border-top: 1px solid var(--foreground2);
        }
    </style>
</head>
<body>
    <div class="log-box" id="log-box">
        <div class="logo-ascii">  ██╗     ██╗   ██╗███╗   ███╗███████╗███╗   ██╗███╗   ███╗ ██████╗ ███╗   ██╗
  ██║     ██║   ██║████╗ ████║██╔════╝████╗  ██║████╗ ████║██╔═══██╗████╗  ██║
  ██║     ██║   ██║██╔████╔██║█████╗  ██╔██╗ ██║██╔████╔██║██║   ██║██╔██╗ ██║
  ██║     ██║   ██║██║╚██╔╝██║██╔══╝  ██║╚██╗██║██║╚██╔╝██║██║   ██║██║╚██╗██║
  ███████╗╚██████╔╝██║ ╚═╝ ██║███████╗██║ ╚████║██║ ╚═╝ ██║╚██████╔╝██║ ╚████║
  ╚══════╝ ╚═════╝ ╚═╝     ╚═╝╚══════╝╚═╝  ╚═══╝╚═╝     ╚═╝ ╚═════╝ ╚═╝  ╚═══╝</div>
        <div id="log-entries"></div>
    </div>

    <div class="shortcuts">
        <kbd>i</kbd> invite · <kbd>r</kbd> refresh · <kbd>h</kbd> help · <kbd>esc</kbd> close
    </div>

    <section>
        <h2>STATUS</h2>
            <div class="section-content">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">console</div>
                        <div class="status-value">online</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ssh</div>
                        <div class="status-value">:2345</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">web</div>
                        <div class="status-value">:8080</div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2>INVITE</h2>
            <div class="section-content">
                <button onclick="createInvite()">create invite</button>
                <div id="invite-container"></div>
            </div>
        </section>

        <section>
            <h2>AGENTS</h2>
            <div class="section-content">
                <div id="agents-container">
                    <div class="no-data">loading...</div>
                </div>
            </div>
        </section>

    <footer>
        lumenmon console
    </footer>

    <script src="/js/keyboard.js"></script>

    <script>
        // Logging system
        function addLog(message, level = 'info') {
            const logEntries = document.getElementById('log-entries');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span class="log-level-${level}">${message}</span>`;
            logEntries.appendChild(entry);

            // Auto-scroll to bottom
            const logBox = document.getElementById('log-box');
            logBox.scrollTop = logBox.scrollHeight;

            // Keep max 50 entries
            while (logEntries.children.length > 50) {
                logEntries.removeChild(logEntries.firstChild);
            }
        }

        let previousAgentCount = 0;

        async function fetchAgents() {
            try {
                const response = await fetch('/api/agents');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                displayAgents(data);

                // Log agent changes
                if (data.agents) {
                    const currentCount = data.agents.length;
                    if (previousAgentCount !== 0 && currentCount > previousAgentCount) {
                        addLog(`agent connected (total: ${currentCount})`, 'success');
                    } else if (previousAgentCount !== 0 && currentCount < previousAgentCount) {
                        addLog(`agent disconnected (total: ${currentCount})`, 'error');
                    }
                    previousAgentCount = currentCount;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('agents-container').innerHTML =
                    `<div class="no-data">error: ${error.message}</div>`;
                addLog(`error fetching agents: ${error.message}`, 'error');
            }
        }

        function displayAgents(data) {
            const container = document.getElementById('agents-container');

            if (!data.agents || data.agents.length === 0) {
                container.innerHTML = '<div class="no-data">no agents connected</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <td>id</td>
                            <td>status</td>
                            <td>cpu</td>
                            <td>mem</td>
                            <td>disk</td>
                            <td>age</td>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.agents.forEach(agent => {
                const age = formatAge(agent.age);
                const cpuBar = generateBar(agent.cpu);
                const memBar = generateBar(agent.memory);
                const diskBar = generateBar(agent.disk);

                html += `
                    <tr>
                        <td>${agent.id}</td>
                        <td><span is-="badge" variant-="${getBadgeVariant(agent.status)}">${agent.status}</span></td>
                        <td>${agent.cpu.toFixed(1)}%<span class="metric-bar">${cpuBar}</span></td>
                        <td>${agent.memory.toFixed(1)}%<span class="metric-bar">${memBar}</span></td>
                        <td>${agent.disk.toFixed(1)}%<span class="metric-bar">${diskBar}</span></td>
                        <td>${age}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function getBadgeVariant(status) {
            const variants = {
                'online': 'foreground0',
                'stale': 'foreground1',
                'offline': 'foreground2'
            };
            return variants[status] || 'foreground2';
        }

        function generateBar(value) {
            const blocks = Math.floor(value / 10);
            return '█'.repeat(Math.min(blocks, 10));
        }

        function formatAge(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
            return `${Math.floor(seconds / 86400)}d`;
        }

        async function createInvite() {
            const container = document.getElementById('invite-container');
            container.innerHTML = '<div class="message">creating...</div>';
            addLog('creating invite...', 'info');

            try {
                const response = await fetch('/api/invites/create', { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data.success) {
                    container.innerHTML = `
                        <div class="invite-box">
                            <div>click to copy:</div>
                            <div class="invite-url" onclick="copyToClipboard('${data.invite_url}')" title="click to copy">
                                ${data.invite_url}
                            </div>
                            <div class="message">valid for 5 minutes</div>
                        </div>
                    `;
                    addLog('invite created (valid 5 min)', 'success');
                } else {
                    container.innerHTML = `<div class="message">error: ${data.error}</div>`;
                    addLog(`invite creation failed: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `<div class="message">error: ${error.message}</div>`;
                addLog(`invite creation error: ${error.message}`, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const container = document.getElementById('invite-container');
                const msg = container.querySelector('.message');
                if (msg) {
                    msg.textContent = 'copied!';
                    setTimeout(() => { msg.textContent = 'valid for 5 minutes'; }, 2000);
                }
                addLog('invite url copied to clipboard', 'info');
            }).catch(err => {
                console.error('Copy failed:', err);
                addLog('clipboard copy failed', 'error');
            });
        }

        // Initialize
        addLog('console started', 'success');
        addLog('loading agents...', 'info');
        fetchAgents();
        setInterval(fetchAgents, 3000);
    </script>
</body>
</html>
